#!/bin/bash

# Use odoo-helper --help for a documentation


SCRIPT=$0;
SCRIPT_NAME=`basename $SCRIPT`;
F=`readlink -f $SCRIPT`;  # full script path;
WORKDIR=`pwd`;

# load basic conf
if [ -f "/etc/odoo-helper.conf" ]; then
    source "/etc/odoo-helper.conf";
fi
if [ -f "$HOME/odoo-helper.conf" ]; then
    source "$HOME/odoo-helper.conf";
fi
# -----------

set -e;  # Fail on errors


if [ -z $ODOO_HELPER_LIB ]; then
    echo "Odoo-helper-scripts seems not been installed correctly.";
    echo "Reinstall it (see Readme on https://github.com/katyukha/odoo-helper-scripts/)";
    exit 1;
fi

# Load common functions
source $ODOO_HELPER_LIB/common.bash; 

ohelper_require fetch;
ohelper_require server;
ohelper_require db;
ohelper_require 'test';
ohelper_require addons;
ohelper_require 'install'
ohelper_require 'git';
# ----------------------------------------------------------------------------------------

function print_usage {
    echo "
    Odoo helper script collection

    Version: $ODOO_HELPER_VERSION

    Usage:
        $SCRIPT_NAME [global options] command [command options]

    Current project settings:
        Project dir: ${PROJECT_ROOT_DIR:-'No project found'};
        Branch:      ${ODOO_BRANCH:-'Not defined'}

    Available commands:
        fetch [--help]                           - fetch and install odoo addon
        link [--help]                            - link module to custom_addons dir
        server [--help]                          - manage local odoo server (run, start, stop, etc)
        addons [--help]                          - addons related helpers
        test [--help]                            - test addon
        db [--help]                              - database management (list, create, drop, etc...)
        generate_requirements [addons dir]       - parse addons dir, find all addons that are
                                                   git repositories and print odoo-requirements.txt content
                                                   file content suitable for *fetch* subcommand.
                                                   for example:
                                                       $SCRIPT_NAME generate_requirements > odoo_requirements.txt
                                                   and you can use generated file for fetch subcommand:
                                                       $SCRIPT_NAME fetch --requirements odoo_requirements.txt
        update_odoo                              - update odoo source code
        odoo-py [args]                           - run project-specific odoo.py script
        print_config                             - print current configuration
        status                                   - show project status
        system update [branch]                   - update odoo-helper-scripts
        system lib-path <lib name>               - print path to lib with specified name
                                                   this allows to use some libs of this project in external utils
        exec <cmd> [args]                        - exec command in project environment. Useful if virtualenv is used
        help | --help | -h                       - display this help message
    
    Global options:
        --addons-dir <addons_directory>
        --downloads-dir <downloads_directory>
        --virtual-env <virtual_env_dir>       - optional, if specified, python dependencies
                                                will be installed in that virtual env
        --use-copy                            - if set, then downloaded modules, repositories will
                                                be copied instead of being symlinked
        --use-unbuffer                        - if set, then 'unbuffer' command from 'expect' package will be used
                                                otherwise standard 'exec' will be used to run odoo server
                                                this helps to make odoo server think that it runs in terminal thus
                                                it provides colored output.
        --verbose|--vv                        - show extra output

    Also global options may be set up using configuration files.
    Folowing file paths will be searched for file $CONF_FILE_NAME:
        - /etc/default/$CONF_FILE_NAME  - Default conf. there may be some general settings placed
        - $HOME/$CONF_FILE_NAME         - User specific oconf  (overwrites previous conf)
        - Project specific conf         - File $CONF_FILE_NAME will be searched in $WORKDIR and all parent
                                          directories. First one found will be used

    Configuration files are simple bash scripts that sets environment variables

    Available environment variables:
        DOWNLOADS_DIR                   - Directory where all downloads hould be placed
        ADDONS_DIR                      - directory to place addons fetched (thats one in odoo's addons_path)
        VENV_DIR                        - Directory of virtual environment, if virtualenv is used
                                          Note, that if VENV_DIR not set, than system will think that odoo is installed system-wide.
        USE_COPY                        - If set, then addons will be coppied in addons dir, instead of standard symlinking
        ODOO_BRANCH                     - used in run_server command to decide how to run it
        ODOO_TEST_CONF_FILE             - used to run tests. this configuration file will be used for it
";
}


# generate_requirements [addons path]
# prints odoo-requirements file content (only addons which are git repositories)
function generate_requirements {
    local req_addons_dir=${1:-$ADDONS_DIR};
    local cdir=`pwd`;

    for repo in $(addons_list_repositories $req_addons_dir); do
        cd $repo;
        local fetch_line="-r `git_get_remote_url` -b `git_get_branch_name`";
        echo "$fetch_line";
        cd $cdir;
    done
}

# downoload latest odoo of this version and reinstall it
function update_odoo_sources {
    echo -e "${LBLUEC}Updating odoo sources...${NC}";
    local FILE_SUFFIX=`date -I`.`random_string 4`;
    local BACKUP_PATH=$BACKUP_DIR/odoo.sources.$ODOO_BRANCH.$FILE_SUFFIX.tar.gz
    local wget_opt="";

    [ ! -z $VERBOSE ] && wget_opt="$wget_opt -q";
    
    (cd $ODOO_PATH/.. && tar -czf $BACKUP_PATH `basename $ODOO_PATH`);
    echo -e "${LBLUEC}Odoo sources backup saved at:${NC} $BACKUP_PATH";

    if [ -d "$ODOO_PATH/.git" ]; then
        echo -e "${LBLUEC}Odoo source seems to be git repository. Attemt to update...${NC}";
        # TODO: check repo branch and branch present odoo-helper config
        if git_is_clean $ODOO_PATH; then
            (cd $ODOO_PATH && git pull);
        else
            echo -e "${REDC}Odoo sources directory is not clean! Do update manual!${NC}";
        fi
    else
        echo -e "${LBLUEC}Downloading new sources archive...${NC}"
        local ODOO_ARCHIVE=$DOWNLOADS_DIR/odoo.$ODOO_BRANCH.$FILE_SUFFIX.tar.gz
        wget $wget_opt -O $ODOO_ARCHIVE https://github.com/odoo/odoo/archive/$ODOO_BRANCH.tar.gz;
        rm -r $ODOO_PATH;
        (cd $DOWNLOADS_DIR && tar -zxf $ODOO_ARCHIVE && mv odoo-$ODOO_BRANCH $ODOO_PATH);
    fi

    echo -e "${LBLUEC}Reinstalling odoo...${NC}";

    # Run setup.py with gevent workaround applied.
    odoo_run_setup_py;  # imported from 'install' module

    echo -e "${GREENC}Odoo sources update finished!${NC}";
}

# display project status
function show_project_status {
    local pid=$(server_get_pid);
    local server_status=;
    if [ $pid -gt 0 ]; then
        server_status="Running ($pid)";
    else
        server_status="Stopped";
    fi

    echo "Current project:

        Project dir: ${PROJECT_ROOT_DIR:-'No project found'};
        Odoo branch: ${ODOO_BRANCH:-'Not defined'}
        Server status: ${server_status}
    ";
}

# update odoo-helper-scripts
function update_odoo_helper_scripts {
    local scripts_branch=$1;

    # update
    local cdir=$(pwd);
    cd $ODOO_HELPER_ROOT;
    if [ -z $scripts_branch ]; then
        git pull;
    else
        git fetch origin;
        git checkout origin/$scripts_branch;
    fi

    # update odoo-helper bin links
    local base_path=$(dirname $ODOO_HELPER_ROOT);
    for oh_cmd in $ODOO_HELPER_BIN/*; do
        if ! command -v $(basename $oh_cmd) >/dev/null 2>&1; then
            if [ "$base_path" == /opt* ]; then
                sudo ln -s $oh_cmd /usr/local/bin/;
            elif [ "$base_path" == $HOME/* ]; then
                ln -s $oh_cmd $HOME/bin;
            fi
        fi
    done
    cd $cdir;
}

# function that parses commandline arguments and executes commands
function odoo_helper_main {
    # Parse command line options and run commands
    if [[ $# -lt 1 ]]; then
        echo "No options/commands supplied $#: $@";

        # load configuration files at startup
        load_project_conf;

        print_usage;
        exit 0;
    fi

    while [[ $# -gt 0 ]]
    do
        key="$1";
        case $key in
            -h|--help|help)
                print_usage;
                exit 0;
            ;;
            --downloads-dir)
                DOWNLOADS_DIR=$2;
                shift;
            ;;
            --addons-dir)
                ADDONS_DIR=$2;
                shift;
            ;;
            --virtual-env)
                VENV_DIR=$2;
                shift;
            ;;
            --use-copy)
                USE_COPY=1;
            ;;
            --use-unbuffer)
                USE_UNBUFFER=1;
            ;;
            --verbose|-vv)
                VERBOSE=1;
            ;;
            fetch)
                shift;
                load_project_conf;
                fetch_module "$@";
                exit
            ;;
            generate_requirements)
                shift;
                load_project_conf;
                generate_requirements "$@"
                exit;
            ;;
            update_odoo)
                shift;
                load_project_conf;
                update_odoo_sources;
                exit;
            ;;
            link|link_module)
                shift;
                load_project_conf;
                link_module "$@"
                exit;
            ;;
            server)
                shift;
                load_project_conf;
                server "$@";
                exit;
            ;;
            addons)
                shift;
                load_project_conf;
                addons_command "$@";
                exit;
            ;;
            odoo-py)
                shift;
                load_project_conf;
                odoo_py "$@";
                exit;
            ;;
            test)
                shift;
                load_project_conf;
                test_module "$@";
                exit;
            ;;
            db)
                shift;
                load_project_conf;
                odoo_db_command "$@";
                exit;
            ;;
            print_config)
                shift;
                load_project_conf;
                print_helper_config;
                exit;
            ;;
            status)
                load_project_conf;
                show_project_status;
                exit;
            ;;
            system)
                if [ "$2" == "update" ]; then
                    shift;
                    shift;
                    update_odoo_helper_scripts "$@";
                    exit 0;
                elif [ "$2" == "lib-path" ]; then
                    shift;
                    shift;
                    oh_get_lib_path "$@"
                    exit 0;
                fi
            ;;
            exec)
                shift;
                load_project_conf;
                execu "$@";
                exit 0;
            ;;
            *)
                echo "Unknown option global option /command $key";
                exit 1;
            ;;
        esac;
        shift;
    done;
}

odoo_helper_main "$@";

